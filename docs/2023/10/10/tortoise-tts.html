<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>tortoise text to speech (and piper) | hejohns’ jekyll site</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="tortoise text to speech (and piper)" />
<meta name="author" content="Johnson He" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Motivation" />
<meta property="og:description" content="Motivation" />
<link rel="canonical" href="https://hejohns.github.io/2023/10/10/tortoise-tts.html" />
<meta property="og:url" content="https://hejohns.github.io/2023/10/10/tortoise-tts.html" />
<meta property="og:site_name" content="hejohns’ jekyll site" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-10T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="tortoise text to speech (and piper)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Johnson He"},"dateModified":"2023-10-11T06:33:16-04:00","datePublished":"2023-10-10T00:00:00-04:00","description":"Motivation","headline":"tortoise text to speech (and piper)","mainEntityOfPage":{"@type":"WebPage","@id":"https://hejohns.github.io/2023/10/10/tortoise-tts.html"},"url":"https://hejohns.github.io/2023/10/10/tortoise-tts.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://hejohns.github.io/feed.xml" title="hejohns&apos; jekyll site" />  <!-- see: -->
  <!-- https://codewrites.me/jekyll/katex/blog/2020/08/26/use-katex-gh-pages/ -->
  <!-- https://www.xuningyang.com/blog/2021-01-11-katex-with-jekyll/ -->
  <!-- and adjusted according to minima layout -->

  <!--KaTeX-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
  <script>
      document.addEventListener("DOMContentLoaded", function() {
          renderMathInElement(document.body, {
              // ...options...
          });
      });
  </script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">hejohns&#39; jekyll site</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/posts.html">posts</a><a class="page-link" href="/site-construction.html">site-construction</a><a class="page-link" href="/reviews.html">reviews</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
          <h3>
            page version: October 11, 2023
          </h3>
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">tortoise text to speech (and piper)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-10-10T00:00:00-04:00" itemprop="datePublished">
        original date: Oct 10, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="motivation">Motivation</h2>

<p>I’m getting my butt kicked by EECS 582.
We’re assigned four papers a week to read–
two for Tuesday, two for Thursday–
and it’s just too much to read with attention to detail.
But I don’t think the point <em>is</em> to read every paper in detail.
Or at least that’s not what I really want out of it.</p>

<p>This seems to me an exercise in how to quickly synthesize/accumulate/index
ideas and knowledge,
and how to summarize/distill it quickly.
(The paper reviews used to take me hours, but there just isn’t the time for that.
 I’ve been cramming it into ~45 minutes.)</p>

<p>As such, I’m looking for fast ways to get to the summary,
if that’s the end-goal, so to speak.
There’s some tips and tricks people will tell you when it comes to reading papers,
but I wanted to try something more aggressive.</p>

<h2 id="text-to-speech-tools">text to speech tools</h2>

<p>My eyes were feeling uncomfortable from (I have no medical backing to say this)
all the, well, load, of screen + reading time,
so the natural conclusion was to try <em>listening</em> to papers.</p>

<p>So I copy/pasted the entire paper pdf into a text file,
removed line breaks (eg “libr-\nary”),
and converted the text to audio with a tts tool.</p>

<p>Of course this requires that the paper has signifiant amounts of prose.
The papers we’re reading in 582 do<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> (and more on the effectiveness of the tts tools on papers below), but I have yet to try other areas.</p>

<p>I first tried some online tools, but wasn’t very satisfied.
I’m sure there are good services online though.</p>

<p>In any case, I ended up trying local text to speech tools,
and the two that I got working were:</p>
<ul>
  <li><a href="https://github.com/rhasspy/piper">piper</a></li>
  <li><a href="https://github.com/neonbjb/tortoise-tts">tortoise-tts</a></li>
</ul>

<p>(festival kept crashing, and I think I forgot to try eSpeak-ng.)</p>

<h3 id="piper">piper</h3>
<p>There’s not much to say.
Piper “just works”.
It’s fast– it can stream audio– and sounds good enough to listen to papers.
I’ve been using **cpu inference. I’m not sure if it supports gpu.</p>

<p>This is what I’ve actually been using since tortoise…
didn’t “just work” out of the box.</p>

<p>For some reason, the wav file piper produces isn’t readable on my sony icd,
so I had to ffmpeg it to an mp3.</p>
<h3 id="tortoise">tortoise</h3>
<p>Okay… this is the real reason I wrote this post.</p>

<p>The output quality of tortoise is fantastic.
Yes, it’s slow, but I’m willing to put up with it if it works–
just run it overnight/overnight + a day.
I have yet to really evaluate it as a paper reading tool, because I’ve been so bogged down trying to get it working.</p>

<h4 id="docker">docker</h4>
<p>First, <strong>cpu</strong> only:</p>

<p>The Dockerfile provided works with some small modifications
which others noted in the issue comments and a PR.
So I made a <a href="https://github.com/eecs582-andlars-hasinha-hejohns/tortoise-tts">fork</a>
with those patches.</p>

<p>tortoise hardcodes cuda in some places, so a couple patches are needed, but it does run with only cpu.
Just invoke <code class="language-plaintext highlighter-rouge">docker run</code> without <code class="language-plaintext highlighter-rouge">--gpus all</code>.</p>
<h4 id="gpu">gpu</h4>
<p>I have an nvidia mobile gpu on my desktop (the one from <a href="/2023/05/10/linux-graphics-modules.html">the post about nvidia kernel modules</a>,
so I thought I’d try to see how it compares to cpu tortoise,
which I’d been running on a dual xeon gold 6142.</p>

<p>It became issue after issue.</p>

<p>So first you have to install <code class="language-plaintext highlighter-rouge">nvidia-container-toolkit</code>.
Then when I added <code class="language-plaintext highlighter-rouge">--gpus all</code> back to tortoise’s <code class="language-plaintext highlighter-rouge">docker run</code>,
docker failed to pickup any gpus.</p>

<p>Okay… everything seemed fine with the gpu setup (<code class="language-plaintext highlighter-rouge">nvidia-smi</code> shows output, no systemd nvidia service errors like <a href="/2023/05/10/linux-graphics-modules.html">the post about nvidia kernel modules</a>),
except <code class="language-plaintext highlighter-rouge">nvidia-detect</code> errored out,
complaining about not being able to identify the debian version.</p>

<p>After a display of poor debugging skills, I finally looked at <code class="language-plaintext highlighter-rouge">vim $(which nvidia-detect)</code> and searched for the error message.
It turned out the nvidia-detect script just hardcodes some logic for each debian release,
and looks up the value in <code class="language-plaintext highlighter-rouge">/etc/debian_version</code> to dispatch one of the cases.
If <code class="language-plaintext highlighter-rouge">/etc/debian_version</code> doesn’t match any of the cases,
an error message prints about not being able to identify  the debian version.</p>

<p>Well, I have debian testing on my desktop, with
<code class="language-plaintext highlighter-rouge">cat /etc/debian_version</code><sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> showing <code class="language-plaintext highlighter-rouge">trixie/sid</code>.
Which just wasn’t a case.
nvidia-detect only hardcoded up to bookworm/debian 12.</p>

<p>My best guess is that the proper fix is to just wait for a newer nvidia-detect.
But I wanted some more immediate closure, so I manually set <code class="language-plaintext highlighter-rouge">/etc/debian_version</code>
to “bookworm/12”, and everyone was happy.</p>

<p>Then docker <code class="language-plaintext highlighter-rouge">--gpus all</code> was finally happy, but tortoise still wasn’t using the gpu.
Another <em>insert search engine</em> adventure later about cuda versions
suggested that I did in fact have a card that supported cuda 12.0,
which should work with tortoise
(I think tortoise itself wanted cuda 11.7, and the Dockerfile wanted the nvidia cuda 12.2 docker image, which may have worked, but I downgraded it to 12.0 to match my host system).</p>

<p>Then the online oracles said to run <code class="language-plaintext highlighter-rouge">python -m torch.utils.collect_env</code>
to see what pytorch was up to.
And indeed, it showed that pytorch was <em>not</em> built with cuda.</p>

<p>I’m not sure why, given that the Dockerfile seems to install pytorch with cuda,
but in any case, there’s no shortage of hacks here, so the oracle said to
just <code class="language-plaintext highlighter-rouge">pip uninstall torch</code> and reinstall it with cuda, as per <a href="https://pytorch.org/get-started/locally/">the pytorch site</a>,
so I did,
and <code class="language-plaintext highlighter-rouge">python -m torch.utils.collect_env</code> changed to show that cuda was enabled.
This is all in a docker container, so I don’t actually mind how much of a hack this is.</p>

<p>With pytorch finally gpu enabled, I fired up tortoise for the nth time,
and it quickly died with a cuda out of memory error.</p>

<p>The cognoscenti may have noticed that I wanted to do this on a quadro M620
with 2GB ram.
Me being an ML-ignorant fool, didn’t think that that was insufficient.</p>

<p>Even with <code class="language-plaintext highlighter-rouge">batch_size = 1</code>, as small as possible<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>,
tortoise still kept running out of memory.
From what I could find in the issue comments, 4GB is considered a small memory footprint, so it may be that tortoise simply cannot run on 2GB gpu ram.</p>

<p>So I finally got some closure, and four hours less sleep,
but on the plus side,
docker’s quite pleasant to use?</p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>figures don’t meaningfully work if they do at all. They usually don’t get copied as text, and if some parts of the figure do, it’s all mangled. That said, captions <em>do</em> work, and are sometimes enough to get the general idea. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>what is this used for?? <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>I’m assuming that means something to the ML-literate <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div><!-- use minima's column styling since I don't know css -->
  <div class="footer-col-wrapper">
      <div class="footer-col"><a href="/2023/08/03/nic-bonding.html">prev</a></div>
      <div class="footer-col">
        <h2> related </h2>
        <ul><li><a href="/2023/04/23/scripting.html">some remarks apropos scripting,</a></li><li><a href="/2023/05/10/linux-graphics-modules.html">multiple displays and linux graphics modules,</a></li><li><a href="/site-construction/2023/04/05/welcome-to-jekyll.html">Welcome to Jekyll!,</a></li><li><a href="/site-construction/2023/11/06/live-reload.html">Live Reload,</a></li><li><a href="/2023/07/24/book-catalogue.html">book catalogue,</a></li><li><a href="/site-construction/2023/05/14/darcs.html">moving from git to darcs,</a></li><li><a href="/2023/04/10/miserliness.html">funny sayings,</a></li><li><a href="/2023/04/09/gsi-applications.html">my gsi application videos,</a></li><li><a href="/2023/04/14/rasterize-pdfs.html">rasterizing pdfs, among other things,</a></li><li><a href="/site-construction/2023/04/05/katex-test.html">latex with katex,</a></li><li><a href="/2023/05/07/nonstandard-analysis.html">shelving studying nonstandard analysis,</a></li></ul>
      </div>
      <div class="footer-col"><a href="/2023/10/29/coordinating-processes.html">next</a></div>
  </div>

  <a class="u-url" href="/2023/10/10/tortoise-tts.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <!-- I don't need this
        <p class="feed-subscribe">
          <a href="https://hejohns.github.io/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        -->
        <ul class="contact-list">
          <li class="p-name">Johnson He</li>
          <li><a class="u-email" href="mailto:(hejohns)α(umich)δ(edu)">(hejohns)α(umich)δ(edu)</a></li>
            <li>(the answer is yes, you should.)</li>
        </ul>
        <!-- add last-modified-time -->
        <p>site version: 2023-11-06</p>
      </div>
      <div class="footer-col">
        <p>a pure waste of space</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/hejohns" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
